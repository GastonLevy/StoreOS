{% extends 'index.html' %}
{% load static %}

{% block title %}Detalles de la Caja{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Columna izquierda: Información, Resumen, Ingresos y Movimientos de Caja -->
        <div class="col-md-6">
            <!-- Información de la Caja -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-info-circle me-1"></i> Información de la Caja
                </div>
                <div class="card-body">
                    <table class="table table-striped table-bordered">
                        <tbody>
                            <tr>
                                <th scope="row">Usuario</th>
                                <td>{{ cash_register.user.username }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Nombre</th>
                                <td>{{ user.first_name }} {{ user.last_name }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Estado</th>
                                <td>
                                    {% if cash_register.status == 'abierta' %}
                                    <span class="badge bg-success">Abierta</span>
                                    {% else %}
                                    <span class="badge bg-danger">Cerrada</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">Fecha de Apertura</th>
                                <td>{{ cash_register.created_at }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Fecha de Cierre</th>
                                <td>
                                    {% if cash_register.closed_at %}
                                    {{ cash_register.closed_at }}
                                    {% else %}
                                    No cerrada
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'cash-register-list' %}" class="btn btn-secondary">Volver al listado</a>
                        {% if cash_register.status == 'abierta' %}
                        <form method="POST" action="{% url 'close-cash-register' cash_register.pk %}">
                            {% csrf_token %}
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <input type="number"
                                        class="form-control {% if form.closing_balance.errors %}is-invalid{% endif %}"
                                        id="closing_balance" name="closing_balance" value="{{ closing_balance }}"
                                        min="0" step="0.01" placeholder="Saldo final" required>
                                    {% for error in form.closing_balance.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <button type="submit" class="btn btn-danger">Cerrar Caja</button>
                            </div>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Resumen de Caja -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-line me-1"></i> Resumen de Caja
                </div>
                <div class="card-body">
                    <table class="table table-striped table-bordered mb-4">
                        <tbody>
                            <tr>
                                <th scope="row">Saldo Inicial declarado</th>
                                <td>${{ cash_register.opening_balance }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Saldo Final declarado</th>
                                <td>
                                    {% if cash_register.closing_balance %}
                                    ${{ cash_register.closing_balance }}
                                    {% else %}
                                    No disponible
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <table class="table table-striped table-bordered">
                        <tbody>
                            <tr>
                                <th scope="row">Ingresos por Efectivo</th>
                                <td class="text-success">${{ efectivo_ingresos }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Egresos por Efectivo</th>
                                <td class="text-danger">-${{ vueltos }}</td>
                            </tr>
                            <tr>
                            <th scope="row">Movimientos caja</th>
                                {% if movimientos < 0 %}
                                    <td class="text-danger">
                                        -${{ movimientos|cut:"-" }}
                                    </td>
                                {% elif movimientos > 0 %}
                                    <td class="text-success">
                                        ${{ movimientos }}
                                    </td>
                                {% else %}
                                    <td>
                                        ${{ movimientos }}
                                    </td>   
                                {% endif %}
                            </td>
                            </tr>
                            <tr>
                                <th scope="row">Saldo Final calculado</th>
                                <td>${{ balance_total }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Ingresos por Método de Pago -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Ingresos por Método de Pago</h5>
                </div>
                <div class="card-body">
                    {% if payment_method_totals %}
                    <table class="table table-striped table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>Método de Pago</th>
                                <th>Total Ingresos</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payment_method_totals %}
                            <tr>
                                <td>{{ payment.payment_method__name }}</td>
                                <td class="text-success">${{ payment.total|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p>No hay ingresos registrados por métodos de pago.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Movimientos de Caja -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Movimientos de Caja</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Monto</th>
                                <th>Descripción</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for movement in cash_register.movements.all %}
                            <tr>
                                <td>{{ movement.created_at }}</td>
                                <td>{{ movement.get_type_display }}</td>
                                <td
                                    class="{% if movement.type == 'ingreso' %}text-success{% else %}text-danger{% endif %}">
                                    ${{ movement.amount|floatformat:2 }}
                                </td>
                                <td>{{ movement.description }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4">No hay movimientos registrados.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Columna derecha: Movimiento de productos único -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Movimiento de productos</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for movement in lista_movimientos %}
                            <tr>
                                <td>{{ movement.name }}</td>
                                <td>{{ movement.total_quantity }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="2">No hay movimientos registrados.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}